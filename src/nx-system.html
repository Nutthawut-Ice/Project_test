<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/app-localize-behavior/app-localize-behavior.html">

<link rel="import" href="/src/nx-param.html">
<link rel="import" href="/src/nx-behavior.html">

<link rel="import" href="/src/init-system.html">

<dom-module id="nx-system">
  <template>
    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:app/:page"
        data="{{routeData}}"
    >
    </app-route>
    <app-route
        route="{{route}}"
        pattern="/:app"
        data="{{routeAppOnly}}"
    >
    </app-route>

    <tag-app-load></tag-app-load>

  </template>
  <script>
    querySystem = document.querySelector("nx-system");

    Polymer({
      is:'nx-system',
      properties:{
        role:{
          type:Object,
          value:[
            { path:'app1/page1',role:['admin','manager','user1']}
          ]
        },
        language: {
          type: String,
          value: function(){
            if(typeof localStorage.nxLanguage == 'undefined'){
              localStorage.setItem("nxLanguage", initSystem.language);
            }

            return localStorage.nxLanguage;
            
          },
          observer:'renderLanguage'
        }
      },
      observers: [
        '_routePageChanged(routeData)'
      ],created:function(){
        var decoded = jwt_decode('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiVXNlcjEiLCJyb2xlIjoiYWRtaW4ifQ.oRx_ieJoxSZPv7Y8lM03Qv8Qb24PVmuFpWBUxWEkBcg');
        this.auth = decoded;
      },
      _routePageChanged:function(routeData){
        if(!(typeof routeData.app == 'undefined' && typeof routeData.page == 'undefined' && this.routeAppOnly.app == '')){

          if(!this.checkRole(routeData)){
            this.importHref(
              this.resolveUrl('/src/apps/'+routeData.app+'/'+routeData.page+'.html'),

              (e)=>{
                
                var getPage = document.createElement(routeData.app+'-'+routeData.page);
                getPage.route = routeData;

                this.getLocales(this.layout,routeData.app,(data)=>{
                  mergeLocales = data;
                  if((this.layout!=this.oldLayout)){
                    this.importHref(
                      this.resolveUrl('/src/template/'+this.layout+'/'+this.layout+'.html'),
                      (e)=>{
                        var queryTag = this.$$('tag-app-load');
                        queryTag.innerHTML='';
                        var getLayout = document.createElement(this.layout);
                        getLayout.route = routeData;
                        getLayout.page = getPage;
                        queryTag.appendChild(getLayout);
                      },
                      (e)=>{
                        this.changePath('/error/404')
                      },

                      true
                    );
                  }else if(typeof this.layout == "undefined"){
                    var queryTag = this.$$('tag-app-load');
                    queryTag.innerHTML='';
                    queryTag.appendChild(getPage);
                  }else{
                    var queryTag = this.$$('tag-app-load>'+this.layout);
                    queryTag.route = routeData;
                    queryTag.page = getPage;
                  }

                  this.oldLayout = this.layout;

                });

              },

              (e)=>{
                this.changePath('/error/404')
              },

              true
            );
          }
        }else{
          this.changePath(initSystem.indexPath);
          window.history.pushState(null,null, initSystem.indexPath);
        }
      },
      changePath:function(path){
         this.set('route.path', path);
      },
      getLocales:function(layout,app,callback){

        var splitLayout = layout.split('-')[1];
        var mergeLocales = () => {
          
          
          var mergeData = JSON.parse(JSON.stringify(locales.global));

          for(var key in locales.layouts[splitLayout]) {
              for(var key2 in locales.layouts[splitLayout][key]) {
                mergeData[key][key2] = locales.layouts[splitLayout][key][key2];
              }
          }

          for(var key in locales.apps[app]) {
              for(var key2 in locales.apps[app][key]) {
                mergeData[key][key2] = locales.apps[app][key][key2];
              }
          }
          
          callback(mergeData);

        }

        this.importHref(
          this.resolveUrl('/src/apps/localize.html'),
          (e)=>{

            if(typeof locales == 'undefined'){
              locales = {global:localize};
            }

            this.importHref(
              this.resolveUrl('/src/template/'+layout+'/localize.html'),
              (e)=>{

                if(typeof locales.layouts == 'undefined'){
                  locales.layouts = {};
                }
                if(typeof locales.layouts[splitLayout] == 'undefined'){
                  locales.layouts[splitLayout] = localize;
                }

                this.importHref(
                  this.resolveUrl('/src/apps/'+app+'/localize.html'),
                  (e)=>{

                    if(typeof locales.apps == 'undefined'){
                      locales.apps = {};
                    }

                    if(typeof locales.apps[app] == 'undefined'){
                      locales.apps[app] = localize;
                    }

                    mergeLocales();
                  },
                  null,
                  true
                );

              },
              null,
              true
            );

          },
          null,
          true
        );




      },
      renderLanguage:function(newVal,oldVal){
        if(typeof oldVal != 'undefined'){
          localStorage.nxLanguage = newVal;
          var nxBinding = document.querySelectorAll('[nx-binding]');
          for (i = 0; i < nxBinding.length; i++) {
            nxBinding[i].language = newVal;
          }
          // nxBinding.forEach((item)=>{
          //   item.language = newVal;
          // });
        }
      },
      checkRole:function(app){
        var redirect = true;
        this.role.map((obj,index)=>{
          if(obj.path==(app.app+'/'+app.page)){
            obj.role.map((sObj)=>{
              if(this.auth.role==sObj){
                redirect = false;
              }
            });
          }else{
            redirect = false;
          }
        });
        //console.log('403:',redirect);
        if(redirect){
          this.changePath('/error/403');
        }
        return redirect;
      }
    });

  </script>
</dom-module>
